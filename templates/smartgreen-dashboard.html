<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SafraSmart - NDVI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
    <style>
      .topbar-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .filters-trigger {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.55rem 0.9rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: #ffffff;
        color: #0f172a;
        font-weight: 600;
        letter-spacing: 0.01em;
        cursor: pointer;
        box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
        transition: transform 0.18s ease, box-shadow 0.18s ease;
      }

      .filters-trigger:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 22px rgba(15, 23, 42, 0.12);
      }

      .filters-trigger svg {
        width: 18px;
        height: 18px;
      }

      .filters-overlay {
        position: fixed;
        inset: 0;
        background: rgba(2, 6, 23, 0.68);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 2.5rem 1.5rem;
        z-index: 2000;
      }

      .filters-overlay.active {
        display: flex;
      }

      .filters-panel {
        background: #f8fafc;
        border-radius: 1.5rem;
        width: min(1100px, 100%);
        height: 75vh;
        box-shadow: 0 30px 80px rgba(15, 23, 42, 0.45);
        display: grid;
        grid-template-rows: auto 1fr auto;
        overflow: hidden;
      }

      .filters-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.5rem 2rem 1rem;
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
        background: #ffffff;
      }

      .filters-header h2 {
        margin: 0;
        font-size: 1.2rem;
        color: #0f172a;
      }

      .filters-close {
        border: none;
        background: rgba(15, 23, 42, 0.08);
        color: #0f172a;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        cursor: pointer;
        font-size: 1rem;
      }

      .filters-body {
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 1.5rem;
        padding: 1.5rem 2rem;
        overflow: hidden;
      }

      .filters-controls,
      .filters-map {
        background: #ffffff;
        border-radius: 1rem;
        padding: 1.25rem;
        border: 1px solid rgba(15, 23, 42, 0.08);
        overflow: auto;
      }

      .filters-section-title {
        font-size: 1rem;
        font-weight: 600;
        color: #0f172a;
        margin: 0 0 1rem;
      }

      .filters-field {
        display: grid;
        gap: 0.4rem;
        margin-bottom: 1rem;
      }

      .filters-field label {
        font-size: 0.85rem;
        color: #334155;
        font-weight: 600;
      }

      .filters-field select {
        padding: 0.6rem 0.75rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(15, 23, 42, 0.18);
        background: #f8fafc;
        font-weight: 500;
        color: #0f172a;
      }

      .filters-search {
        display: grid;
        gap: 0.4rem;
        margin-top: 1.25rem;
      }

      .filters-search input {
        padding: 0.6rem 0.75rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(15, 23, 42, 0.18);
        background: #f8fafc;
        font-weight: 500;
        color: #0f172a;
      }

      .filters-list {
        margin-top: 0.75rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: #f8fafc;
        max-height: 220px;
        overflow: auto;
        padding: 0.5rem;
        display: grid;
        gap: 0.4rem;
      }

      .filters-list button {
        border: none;
        background: #ffffff;
        border-radius: 0.6rem;
        padding: 0.45rem 0.6rem;
        text-align: left;
        cursor: pointer;
        font-weight: 600;
        color: #0f172a;
      }

      .filters-list button:hover {
        background: #e2e8f0;
      }

      .filters-checkbox-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.4rem;
        border-radius: 0.6rem;
        background: #ffffff;
      }

      .filters-checkbox-row input {
        width: 16px;
        height: 16px;
      }

      .filters-checkbox-row label {
        font-size: 0.9rem;
        color: #0f172a;
        font-weight: 500;
      }

      .filters-examples {
        font-size: 0.85rem;
        color: #475569;
      }

      .filters-examples strong {
        color: #0f172a;
      }

      .filters-error {
        margin-top: 0.75rem;
        color: #dc2626;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .filters-map {
        display: grid;
        place-items: center;
        color: #64748b;
        font-weight: 500;
        text-align: center;
        background: radial-gradient(circle at top, #f1f5f9 0%, #e2e8f0 100%);
      }

      #filtersMiniMap {
        width: 100%;
        height: 100%;
        border-radius: 0.9rem;
        overflow: hidden;
      }

      .filters-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 1.25rem 2rem 1.5rem;
        border-top: 1px solid rgba(15, 23, 42, 0.08);
        background: #ffffff;
      }

      .filters-footer button {
        padding: 0.6rem 1.2rem;
        border-radius: 0.75rem;
        border: 1px solid transparent;
        font-weight: 600;
        cursor: pointer;
      }

      .filters-apply {
        background: #0f172a;
        color: #ffffff;
      }

      .filters-clear {
        background: #ffffff;
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.18);
      }

      .filters-cancel {
        background: rgba(15, 23, 42, 0.08);
        color: #0f172a;
      }

      @media (max-width: 900px) {
        .filters-panel {
          height: auto;
          max-height: 85vh;
        }
        .filters-body {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Main dashboard layout -->
    <div class="dashboard">
      <!-- Top bar -->
      <div class="topbar">
        <div class="logo">
          <span>üåø</span>
          SafraSmart
        </div>
        <div class="status-indicator">
          <div class="status-item">
            <div class="status-dot"></div>
            <span>API Online</span>
          </div>
          <div class="status-item">
            <span>üìç {{ region or '--' }}</span>
          </div>
          <button class="refresh-btn" type="button" onclick="window.location.reload()">
            <span>üîÑ</span>
            Atualizar
          </button>
        </div>
      </div>

      <div style="padding: 1.5rem 2rem 0;">
        <!-- KPI row -->
        <div class="kpi-section">
          <div class="kpi-card">
            <div class="kpi-header">
              <div class="kpi-icon green">üå±</div>
              <div class="kpi-label">Cultura</div>
            </div>
            <div class="kpi-value" id="kpiCrop">{{ crop or '--' }}</div>
            <div style="margin-top:0.5rem;">
              <select id="cropSelect" style="width:100%;">
                <option value="Cafe">Caf√©</option>
                <option value="Cana-de-a√ßucar">Cana-de-a√ß√∫car</option>
                <option value="Soja/Milho">Soja/Milho</option>
                <option value="Pastagem">Pastagem</option>
                <option value="Citros">Citros</option>
              </select>
            </div>
          </div>
          <div class="kpi-card">
            <div class="kpi-header">
              <div class="kpi-icon blue">üìç</div>
              <div class="kpi-label">Talh√µes</div>
            </div>
            <div class="kpi-value">{{ talhoes_count or '--' }}</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-header">
              <div class="kpi-icon purple">üìÖ</div>
              <div class="kpi-label">Data Base</div>
            </div>
            <div class="kpi-value" id="kpiDate">{{ selected_date or '--' }}</div>
          </div>
        </div>
      </div>

      <div class="main-content">
        <div>
          <!-- Date controls -->
          <div class="form-card">
            <div class="form-grid">
              <div>
                <label>Data selecionada</label>
                <div class="slider-meta">
                  <span id="sliderDate">--</span>
                </div>
              </div>
              <div class="topbar-actions" style="justify-content:flex-end;">
                <button class="filters-trigger" id="openFilters" type="button">
                  <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M3 5.25a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 .56 1.25L14 13.5v4.75a.75.75 0 0 1-1.13.65l-3-1.8a.75.75 0 0 1-.37-.65V13.5L3.19 5.75A.75.75 0 0 1 3 5.25Z"/>
                  </svg>
                  Filtros
                </button>
              </div>
            </div>
          </div>

          <!-- Map + legend -->
          <div class="map-container">
            <div class="map-wrap" id="map"></div>
            <!-- Loading overlay -->
            <div class="map-loading" id="mapLoading">
              <div class="map-loading-card">
                <div class="spinner"></div>
                <div class="map-loading-text">Carregando NDVI...</div>
              </div>
            </div>
            <!-- NDVI legend -->
            <div class="legend">
              <div class="legend-title">√çndice NDVI</div>
              <div class="legend-item">
                <div class="legend-color" style="background:#22c55e;"></div>
                <span>0.7 - 1.0 Saud√°vel</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background:#fb923c;"></div>
                <span>0.5 - 0.7 M√©dio</span>
              </div>
            <div class="legend-item">
              <div class="legend-color" style="background:#ef4444;"></div>
              <span>0.0 - 0.5 Alerta</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:#6b7280;"></div>
              <span>&lt; 0.0 Sem dado / negativo</span>
            </div>
          </div>
          </div>
        </div>

        <div class="side-panel">
          <!-- Selected polygon info -->
          <div class="panel-card">
            <div class="panel-title">üìç Talh√£o selecionado</div>
            <div class="info-row">
              <span class="info-label">√Årea</span>
              <span class="info-value" id="talhaoArea">-- ha</span>
            </div>
            <div class="info-row">
              <span class="info-label">NDVI Atual</span>
              <span class="info-value" id="talhaoNdvi">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">Status</span>
              <span class="info-value" id="talhaoStatus">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">Pixels v√°lidos</span>
              <span class="info-value" id="talhaoPixValidos">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">Pixels inv√°lidos</span>
              <span class="info-value" id="talhaoPixInvalidos">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">% v√°lidos</span>
              <span class="info-value" id="talhaoPercValidos">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">Confiabilidade</span>
              <span class="info-value" id="talhaoConfiab">--</span>
            </div>
            <div class="crop-description" id="cropDescription">
              <div class="crop-description-title">Descri√ß√£o da cultura</div>
              <div class="crop-desc-tip">Selecione uma cultura para ver a interpreta√ß√£o do NDVI.</div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="filters-overlay" id="filtersOverlay" aria-hidden="true">
      <div class="filters-panel" role="dialog" aria-modal="true" aria-label="Filtros">
        <div class="filters-header">
          <h2>Filtros</h2>
          <button class="filters-close" type="button" id="closeFilters">X</button>
        </div>
        <div class="filters-body">
          <div class="filters-controls">
            <div class="filters-section-title">Configurar campos do shape</div>
            <div class="filters-field">
              <label for="farmFieldSelect">Campo Fazenda</label>
              <select id="farmFieldSelect">
                <option value="">Selecione um campo</option>
              </select>
              <div class="filters-examples" id="farmFieldExamples">Exemplos: --</div>
            </div>
            <div class="filters-field">
              <label for="fieldFieldSelect">Campo Talh√£o</label>
              <select id="fieldFieldSelect">
                <option value="">Selecione um campo</option>
              </select>
              <div class="filters-examples" id="fieldFieldExamples">Exemplos: --</div>
            </div>
            <div class="filters-error" id="filtersError" style="display:none;"></div>

            <div class="filters-section-title" style="margin-top:1.5rem;">Selecionar fazenda</div>
            <div class="filters-search">
              <label for="farmSearchInput">Busca por fazenda</label>
              <input id="farmSearchInput" type="text" placeholder="Digite o nome da fazenda" />
            </div>
            <div class="filters-list" id="farmList"></div>

            <div class="filters-section-title" style="margin-top:1.25rem;">Selecionar talh√µes</div>
            <div class="filters-checkbox-row">
              <input type="checkbox" id="selectAllFields" checked />
              <label for="selectAllFields">Selecionar todos</label>
            </div>
            <div class="filters-search">
              <label for="fieldSearchInput">Busca por talh√£o</label>
              <input id="fieldSearchInput" type="text" placeholder="Digite o talh√£o ou ID" />
            </div>
            <div class="filters-list" id="fieldList"></div>
          </div>
          <div class="filters-map">
            <div id="filtersMiniMap"></div>
          </div>
        </div>
        <div class="filters-footer">
          <button class="filters-clear" type="button" id="clearFilters">Limpar</button>
          <button class="filters-cancel" type="button" id="cancelFilters">Cancelar</button>
          <button class="filters-apply" type="button" id="applyFilters" disabled>Aplicar</button>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // Dashboard client logic (map + data fetch).
      const jobId = "{{ job_id }}";
      const cropSelect = document.getElementById("cropSelect");
      const kpiCrop = document.getElementById("kpiCrop");
      const kpiDate = document.getElementById("kpiDate");
      const sliderDate = document.getElementById("sliderDate");
      const mapLoading = document.getElementById("mapLoading");
      let ndviFirstLoadDone = false;

      const talhaoArea = document.getElementById("talhaoArea");
      const talhaoNdvi = document.getElementById("talhaoNdvi");
      const talhaoStatus = document.getElementById("talhaoStatus");
      const talhaoPixValidos = document.getElementById("talhaoPixValidos");
      const talhaoPixInvalidos = document.getElementById("talhaoPixInvalidos");
      const talhaoPercValidos = document.getElementById("talhaoPercValidos");
      const talhaoConfiab = document.getElementById("talhaoConfiab");
      const cropDescription = document.getElementById("cropDescription");
      const filtersOverlay = document.getElementById("filtersOverlay");
      const openFiltersBtn = document.getElementById("openFilters");
      const closeFiltersBtn = document.getElementById("closeFilters");
      const cancelFiltersBtn = document.getElementById("cancelFilters");
      const farmFieldSelect = document.getElementById("farmFieldSelect");
      const fieldFieldSelect = document.getElementById("fieldFieldSelect");
      const farmFieldExamples = document.getElementById("farmFieldExamples");
      const fieldFieldExamples = document.getElementById("fieldFieldExamples");
      const filtersError = document.getElementById("filtersError");
      const applyFiltersBtn = document.getElementById("applyFilters");
      const clearFiltersBtn = document.getElementById("clearFilters");
      const farmSearchInput = document.getElementById("farmSearchInput");
      const farmList = document.getElementById("farmList");
      const fieldSearchInput = document.getElementById("fieldSearchInput");
      const fieldList = document.getElementById("fieldList");
      const selectAllFields = document.getElementById("selectAllFields");

      const filterConfig = { farmField: "", fieldField: "" };
      const filterSelection = { farmValue: "", selectedFeatureIds: [], selectAll: true };
      let importId = null;
      let examplesByField = {};
      let farmSearchTimer = null;
      let fieldSearchTimer = null;
      let cachedFarms = [];
      let cachedFields = [];
      let cachedFieldsAll = [];
      let talhoesGeojsonData = null;
      let miniMap = null;
      let miniLayer = null;

      function openFilters() {
        if (!filtersOverlay) return;
        filtersOverlay.classList.add("active");
        filtersOverlay.setAttribute("aria-hidden", "false");
      }

      function closeFilters() {
        if (!filtersOverlay) return;
        filtersOverlay.classList.remove("active");
        filtersOverlay.setAttribute("aria-hidden", "true");
      }

      function restoreAllTalhoes() {
        if (!talhoesGeojsonData) return;
        const exploded = explodeGeojson(talhoesGeojsonData);
        exploded.features.forEach((feature, index) => {
          feature.properties = feature.properties || {};
          feature.properties.__index = feature.properties.__index ?? feature.properties.id ?? index;
        });
        setTalhoesLayer(exploded);
        if (talhoesLayer) {
          const bounds = talhoesLayer.getBounds();
          if (bounds.isValid()) {
            map.fitBounds(bounds, { padding: [24, 24] });
          }
        }
      }

      function resetFilterSelection() {
        filterSelection.farmValue = "";
        filterSelection.selectedFeatureIds = [];
        filterSelection.selectAll = true;
        if (selectAllFields) {
          selectAllFields.checked = true;
        }
        if (farmSearchInput) farmSearchInput.value = "";
        if (fieldSearchInput) fieldSearchInput.value = "";
        if (farmList) farmList.innerHTML = "";
        if (fieldList) fieldList.innerHTML = "";
        if (filtersError) {
          filtersError.textContent = "";
          filtersError.style.display = "none";
        }
        if (importId) {
          loadFarms("");
        }
      }

      function initMiniMap() {
        if (miniMap) return;
        const container = document.getElementById("filtersMiniMap");
        if (!container) return;
        miniMap = L.map(container, { zoomControl: false, attributionControl: false });
        L.tileLayer(
          "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
          { maxZoom: 19 }
        ).addTo(miniMap);
        miniLayer = L.geoJSON([], {
          style: () => ({
            color: "#0f172a",
            weight: 2,
            fillOpacity: 0.0
          })
        }).addTo(miniMap);
        if (talhoesGeojsonData) {
          updateMiniMapLayer();
        }
        setTimeout(() => {
          miniMap.invalidateSize();
        }, 50);
      }

      function updateMiniMapLayer() {
        if (!miniMap || !miniLayer || !talhoesGeojsonData) return;
        let features = talhoesGeojsonData.features || [];
        const selectedIds = new Set((filterSelection.selectedFeatureIds || []).map((id) => Number(id)));
        if (filterSelection.farmValue) {
          if (selectedIds.size > 0) {
            features = features.filter((feat) => selectedIds.has(Number(feat?.properties?.id)));
          } else if (!filterSelection.selectAll) {
            features = [];
          }
        }
        miniLayer.clearLayers();
        miniLayer.addData({ type: "FeatureCollection", features });
        miniLayer.setStyle((feature) => {
          const isSelected = selectedIds.has(Number(feature?.properties?.id));
          return {
            color: "#0f172a",
            weight: isSelected ? 3 : 1.5,
            fillOpacity: 0.0
          };
        });
        if (features.length) {
          const bounds = miniLayer.getBounds();
          if (bounds.isValid()) {
            miniMap.fitBounds(bounds, { padding: [20, 20] });
          }
        }
      }

      function renderExamples(target, fieldName) {
        if (!target) return;
        if (!fieldName) {
          target.textContent = "Exemplos: --";
          return;
        }
        const examples = examplesByField[fieldName] || [];
        target.textContent = examples.length
          ? `Exemplos: ${examples.join(", ")}`
          : "Exemplos: --";
      }

      function validateFilterConfig() {
        if (!filtersError || !applyFiltersBtn) return;
        let errorMessage = "";
        if (filterConfig.farmField && filterConfig.fieldField && filterConfig.farmField === filterConfig.fieldField) {
          errorMessage = "Campo Fazenda e Campo Talh√£o n√£o podem ser iguais.";
        }
        if (errorMessage) {
          filtersError.textContent = errorMessage;
          filtersError.style.display = "block";
          applyFiltersBtn.disabled = true;
        } else {
          filtersError.textContent = "";
          filtersError.style.display = "none";
          applyFiltersBtn.disabled = !(filterConfig.farmField && filterConfig.fieldField);
        }
        if (!errorMessage && filterConfig.farmField && filterConfig.fieldField) {
          saveFilterSchema();
        }
      }

      async function saveFilterSchema() {
        if (!importId) return;
        try {
          await fetch(`/api/import/${importId}/filter-schema`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              farm_field: filterConfig.farmField,
              field_field: filterConfig.fieldField
            })
          });
          if (farmSearchInput) {
            loadFarms(farmSearchInput.value || "");
          } else {
            loadFarms("");
          }
        } catch (err) {
          if (filtersError) {
            filtersError.textContent = "Erro ao salvar configura√ß√£o de campos.";
            filtersError.style.display = "block";
          }
        }
      }

      function renderFarms(items) {
        if (!farmList) return;
        farmList.innerHTML = "";
        if (!items.length) {
          farmList.innerHTML = "<div style='color:#64748b;padding:0.4rem 0.5rem;'>Nenhuma fazenda encontrada.</div>";
          return;
        }
        items.forEach((farm) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = farm.value;
          btn.addEventListener("click", () => {
            filterSelection.farmValue = farm.value;
            filterSelection.selectAll = true;
            if (selectAllFields) {
              selectAllFields.checked = true;
            }
            if (fieldSearchInput) {
              fieldSearchInput.value = "";
            }
            loadFieldsByFarm(farm.value, "", true);
            updateMiniMapLayer();
          });
          farmList.appendChild(btn);
        });
      }

      function renderFields(items) {
        if (!fieldList) return;
        fieldList.innerHTML = "";
        if (!items.length) {
          fieldList.innerHTML = "<div style='color:#64748b;padding:0.4rem 0.5rem;'>Nenhum talh√£o encontrado.</div>";
          return;
        }
        const selectedSet = new Set(filterSelection.selectedFeatureIds.map((id) => Number(id)));
        items.forEach((item) => {
          const row = document.createElement("div");
          row.className = "filters-checkbox-row";
          const input = document.createElement("input");
          input.type = "checkbox";
          input.value = item.feature_id;
          const itemId = Number(item.feature_id);
          input.checked = filterSelection.selectAll || selectedSet.has(itemId);
          input.disabled = filterSelection.selectAll;
          input.addEventListener("change", () => {
            const idVal = itemId;
            if (input.checked) {
              if (!selectedSet.has(idVal)) {
                filterSelection.selectedFeatureIds.push(idVal);
              }
            } else {
              filterSelection.selectedFeatureIds = filterSelection.selectedFeatureIds.filter((id) => id !== idVal);
            }
            updateMiniMapLayer();
          });
          const label = document.createElement("label");
          label.textContent = item.label;
          row.appendChild(input);
          row.appendChild(label);
          fieldList.appendChild(row);
        });
      }

      async function loadFarms(query = "") {
        if (!importId) return;
        const res = await fetch(`/api/import/${importId}/farms?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        cachedFarms = Array.isArray(data.farms) ? data.farms : [];
        renderFarms(cachedFarms);
      }

      async function loadFieldsByFarm(farmValue, query = "", updateSelection = true) {
        if (!importId || !farmValue) return;
        const res = await fetch(
          `/api/import/${importId}/fields-by-farm?farm=${encodeURIComponent(farmValue)}&q=${encodeURIComponent(query)}`
        );
        const data = await res.json();
        const items = Array.isArray(data.fields) ? data.fields : [];
        cachedFields = items;
        if (query === "") {
          cachedFieldsAll = items;
        }
        if (updateSelection) {
          if (filterSelection.selectAll) {
            filterSelection.selectedFeatureIds = cachedFieldsAll.map((item) => Number(item.feature_id));
          } else {
            filterSelection.selectedFeatureIds = [];
          }
        }
        renderFields(items);
        updateMiniMapLayer();
      }

      function debounce(fn, delay, timerRefName) {
        return (...args) => {
          if (timerRefName === "farm") {
            clearTimeout(farmSearchTimer);
            farmSearchTimer = setTimeout(() => fn(...args), delay);
          } else {
            clearTimeout(fieldSearchTimer);
            fieldSearchTimer = setTimeout(() => fn(...args), delay);
          }
        };
      }

      let ndviLayer = null;
      let ndviClassLayer = null;
      let talhoesLayer = null;
      let selectedFeatureLayer = null;
      let currentDate = "{{ selected_date or '' }}";
      const baseDate = "{{ base_date or '' }}";

      const map = L.map("map", { zoomControl: true });
      const imagery = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 19,
          attribution: "Tiles ¬© Esri"
        }
      ).addTo(map);

      const layerControl = L.control.layers(
        { "Sat√©lite": imagery },
        {},
        { collapsed: false }
      ).addTo(map);

      function setNdviTiles(rawUrl, classUrl) {
        if (!ndviFirstLoadDone) {
          setMapLoading(true);
        }
        if (ndviLayer) {
          map.removeLayer(ndviLayer);
          layerControl.removeLayer(ndviLayer);
        }
        if (ndviClassLayer) {
          map.removeLayer(ndviClassLayer);
          layerControl.removeLayer(ndviClassLayer);
        }
        ndviLayer = L.tileLayer(rawUrl, { opacity: 0.55 });
        ndviClassLayer = L.tileLayer(classUrl, { opacity: 0.9 });
        // Start with class layer visible and raw unchecked by default.
        ndviClassLayer.addTo(map);
        layerControl.addOverlay(ndviLayer, "NDVI Raw");
        layerControl.addOverlay(ndviClassLayer, "NDVI Classificado");

        ndviClassLayer.on("loading", () => {
          if (!ndviFirstLoadDone) setMapLoading(true);
        });
        ndviClassLayer.on("load", () => {
          if (!ndviFirstLoadDone) {
            setMapLoading(false);
            ndviFirstLoadDone = true;
          }
        });
        ndviClassLayer.on("tileerror", () => {
          if (!ndviFirstLoadDone) {
            setMapLoading(false);
          }
        });
      }

      function setMapLoading(state) {
        if (!mapLoading) return;
        mapLoading.classList.toggle("active", state);
      }

      function formatNumber(value, decimals = 2) {
        const num = Number(value);
        if (!isFinite(num)) return "--";
        return num.toFixed(decimals);
      }

      function classifyConfiabilidade(percentualValidos) {
        if (!Number.isFinite(percentualValidos)) return { label: "‚Äî", baixa: false };
        if (percentualValidos >= 90) return { label: "Alta confiabilidade", baixa: false };
        if (percentualValidos >= 70) return { label: "M√©dia confiabilidade", baixa: false };
        return { label: "Baixa confiabilidade", baixa: true };
      }

      function updateTalhaoInfo(data) {
        const area = Number(data.area_ha);
        const ndviVal = Number(data.ndvi);
        const pixValidos = Number(data.pixels_validos);
        const pixInvalidos = Number(data.pixels_invalidos);
        const percValidos = Number(data.percentual_validos);
        const { label: confiabLabel } = classifyConfiabilidade(percValidos);

        talhaoArea.textContent = Number.isFinite(area) ? `${area.toFixed(2)} ha` : "-- ha";
        talhaoNdvi.textContent = Number.isFinite(ndviVal) ? ndviVal.toFixed(3) : "--";
        talhaoStatus.textContent = data.status ?? "--";
        talhaoPixValidos.textContent = Number.isFinite(pixValidos) ? pixValidos : "--";
        talhaoPixInvalidos.textContent = Number.isFinite(pixInvalidos) ? pixInvalidos : "--";
        talhaoPercValidos.textContent = Number.isFinite(percValidos) ? `${percValidos.toFixed(2)}%` : "--";
        talhaoConfiab.textContent = confiabLabel;
      }

      function showTalhaoPopup(layer, stats, clickLatLng) {
        if (!layer || !stats) return;
        const ndviMedio = stats.ndvi_medio ?? stats.ndvi;
        const pixelsValidos = stats.pixels_validos;
        const pixelsInvalidos = stats.pixels_invalidos;
        const percentualValidos = stats.percentual_validos;
        const mensagem = stats.mensagem || stats.message;

        const { label: confiabilidade, baixa: baixaConfianca } = classifyConfiabilidade(percentualValidos);

        const popupHtml = `
          <div style="font-weight:600;margin-bottom:4px;">Talh√£o</div>
          <div>NDVI m√©dio: ${formatNumber(ndviMedio, 2)}</div>
          <div>Pixels v√°lidos: ${pixelsValidos ?? "--"}</div>
          <div>Pixels inv√°lidos: ${pixelsInvalidos ?? "--"}</div>
          <div>% v√°lidos: ${formatNumber(percentualValidos, 2)}%</div>
          <div>Confiabilidade: ${confiabilidade}</div>
          ${
            baixaConfianca
              ? `<div style="margin-top:6px;color:#dc2626;font-weight:600;">‚ö†Ô∏è Baixa confiabilidade ‚Äî muitos pixels inv√°lidos</div>`
              : ""
          }
          ${
            mensagem
              ? `<div style="margin-top:6px;color:#dc2626;font-weight:600;">${mensagem}</div>`
              : ""
          }
        `;

        layer.bindPopup(popupHtml, { closeButton: true });
        if (clickLatLng) {
          layer.openPopup(clickLatLng);
        } else if (typeof layer.openPopup === "function") {
          layer.openPopup();
        }
      }

      const CROP_DESCRIPTIONS = {
        "Cana-de-a√ßucar": {
          title: "üå± CANA-DE-A√á√öCAR",
          rows: [
            ["< 0.30", "Solo exposto / falha grave"],
            ["0.30 ‚Äì 0.50", "Desenvolvimento inicial"],
            ["0.50 ‚Äì 0.70", "Crescimento ativo"],
            ["0.70 ‚Äì 0.85", "Alto vigor"],
            ["> 0.85", "Fechamento total / satura√ß√£o"]
          ],
          tip: "üìå Cana madura geralmente fica 0.75 ‚Äì 0.85"
        },
        "Cafe": {
          title: "‚òï CAF√â",
          rows: [
            ["< 0.40", "Estresse / falha"],
            ["0.40 ‚Äì 0.55", "Vigor baixo"],
            ["0.55 ‚Äì 0.70", "Vigor m√©dio"],
            ["0.70 ‚Äì 0.82", "Vigor alto"],
            ["> 0.82", "Copa muito densa"]
          ],
          tip: "üìå Caf√© produtivo saud√°vel geralmente fica 0.65 ‚Äì 0.80"
        },
        "Soja/Milho": {
          title: "üåΩ SOJA / MILHO",
          rows: [
            ["< 0.30", "Emerg√™ncia / falha"],
            ["0.30 ‚Äì 0.50", "Vegetativo inicial"],
            ["0.50 ‚Äì 0.75", "Crescimento forte"],
            ["0.75 ‚Äì 0.90", "Pico vegetativo"],
            ["> 0.90", "Satura√ß√£o (pouco ganho de informa√ß√£o)"]
          ],
          tip: "üìå Soja em R1-R3 pode chegar a 0.80 ‚Äì 0.90"
        },
        "Pastagem": {
          title: "üåæ PASTAGEM",
          rows: [
            ["< 0.35", "Degradada"],
            ["0.35 ‚Äì 0.55", "Baixa biomassa"],
            ["0.55 ‚Äì 0.70", "Boa condi√ß√£o"],
            ["0.70 ‚Äì 0.85", "Alta biomassa"],
            ["> 0.85", "Muito densa"]
          ],
          tip: "üìå Pastagem boa normalmente 0.60 ‚Äì 0.75"
        },
        "Citros": {
          title: "üçä CITROS",
          rows: [
            ["< 0.45", "Estresse"],
            ["0.45 ‚Äì 0.60", "Vigor m√©dio"],
            ["0.60 ‚Äì 0.75", "Boa condi√ß√£o"],
            ["0.75 ‚Äì 0.85", "Copa fechada"],
            ["> 0.85", "Satura√ß√£o"]
          ],
          tip: "üìå Pomar saud√°vel costuma ficar 0.65 ‚Äì 0.80"
        }
      };

      function renderCropDescription(crop) {
        if (!cropDescription) return;
        const data = CROP_DESCRIPTIONS[crop];
        if (!data) {
          cropDescription.innerHTML = `
            <div class="crop-description-title">Descri√ß√£o da cultura</div>
            <div class="crop-desc-tip">Selecione uma cultura para ver a interpreta√ß√£o do NDVI.</div>
          `;
          return;
        }
        const rowsHtml = data.rows
          .map(
            ([range, label]) => `
              <div class="crop-desc-row">
                <span class="crop-desc-range">${range}</span>
                <span class="crop-desc-label">${label}</span>
              </div>
            `
          )
          .join("");
        cropDescription.innerHTML = `
          <div class="crop-description-title">${data.title}</div>
          <div class="crop-desc-header">
            <span>NDVI</span>
            <span>Interpreta√ß√£o</span>
          </div>
          ${rowsHtml}
          <div class="crop-desc-tip">${data.tip}</div>
        `;
      }

      function applySelectedStyle(layer) {
        if (talhoesLayer && typeof talhoesLayer.resetStyle === "function") {
          talhoesLayer.resetStyle();
        } else if (selectedFeatureLayer) {
          selectedFeatureLayer.setStyle({ color: "#FFD166", weight: 1, fillOpacity: 0.0 });
        }
        selectedFeatureLayer = layer;
        selectedFeatureLayer.setStyle({ color: "#22c55e", weight: 2, fillOpacity: 0.1 });
        if (typeof selectedFeatureLayer.bringToFront === "function") {
          selectedFeatureLayer.bringToFront();
        }
      }

      function explodeGeojson(data) {
        if (!data || !Array.isArray(data.features)) return data;
        const exploded = [];
        data.features.forEach((feature) => {
          if (!feature || !feature.geometry) return;
          const geom = feature.geometry;
          if (geom.type === "MultiPolygon" && Array.isArray(geom.coordinates)) {
            geom.coordinates.forEach((coords, partIndex) => {
              exploded.push({
                type: "Feature",
                properties: { ...(feature.properties || {}), __part: partIndex },
                geometry: { type: "Polygon", coordinates: coords }
              });
            });
          } else {
            exploded.push(feature);
          }
        });
        return { ...data, features: exploded };
      }

      function pointInRing(point, ring) {
        let inside = false;
        for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
          const xi = ring[i].lng;
          const yi = ring[i].lat;
          const xj = ring[j].lng;
          const yj = ring[j].lat;
          const intersect = (yi > point.lat) !== (yj > point.lat) &&
            point.lng < ((xj - xi) * (point.lat - yi)) / (yj - yi + 0.0) + xi;
          if (intersect) inside = !inside;
        }
        return inside;
      }

      function pointInLatLngs(point, latlngs) {
        if (!Array.isArray(latlngs) || latlngs.length === 0) return false;
        if (latlngs[0].lat !== undefined) {
          return pointInRing(point, latlngs);
        }
        if (Array.isArray(latlngs[0]) && latlngs[0][0] && latlngs[0][0].lat !== undefined) {
          if (!pointInRing(point, latlngs[0])) return false;
          for (let i = 1; i < latlngs.length; i++) {
            if (pointInRing(point, latlngs[i])) return false;
          }
          return true;
        }
        for (const poly of latlngs) {
          if (pointInLatLngs(point, poly)) return true;
        }
        return false;
      }

      function pickBestLayerAtPoint(point) {
        if (!talhoesLayer) return null;
        let bestLayer = null;
        let bestArea = Infinity;
        talhoesLayer.getLayers().forEach((layer) => {
          const latlngs = layer.getLatLngs();
          if (!pointInLatLngs(point, latlngs)) return;
          const bounds = layer.getBounds();
          const area = Math.abs((bounds.getNorth() - bounds.getSouth()) * (bounds.getEast() - bounds.getWest()));
          if (area < bestArea) {
            bestArea = area;
            bestLayer = layer;
          }
        });
        return bestLayer;
      }

      function setTalhoesLayer(exploded) {
        if (talhoesLayer) {
          map.removeLayer(talhoesLayer);
        }
        talhoesLayer = L.geoJSON(exploded, {
          style: () => ({
            color: "#FFD166",
            weight: 1,
            fillOpacity: 0.0
          })
        }).addTo(map);
      }

      async function loadTalhoes() {
        const res = await fetch(`/api/job/${jobId}/talhoes`);
        const data = await res.json();
        if (!data || !data.features) return;

        talhoesGeojsonData = data;
        updateMiniMapLayer();

        const exploded = explodeGeojson(data);

        exploded.features.forEach((feature, index) => {
          feature.properties = feature.properties || {};
          feature.properties.__index = feature.properties.__index ?? feature.properties.id ?? index;
        });

        setTalhoesLayer(exploded);

        map.on("click", async (event) => {
          const picked = pickBestLayerAtPoint(event.latlng);
          if (!picked) return;
          const idx = picked.feature && picked.feature.properties
            ? picked.feature.properties.__index
            : undefined;
          if (typeof idx !== "number") return;
          applySelectedStyle(picked);
          if (!currentDate) return;
          const statsRes = await fetch(
            `/api/job/${jobId}/talhao_stats?index=${idx}&date=${encodeURIComponent(currentDate)}`
          );
          const stats = await statsRes.json();
          if (!stats || stats.error) return;
          updateTalhaoInfo(stats);
          showTalhaoPopup(picked, stats, event.latlng);
        });
      }

      async function loadTiles(dateStr) {
        if (!dateStr) return;
        if (!ndviFirstLoadDone) {
          setMapLoading(true);
        }
        const res = await fetch(`/api/job/${jobId}/tiles?date=${encodeURIComponent(dateStr)}`);
        const tiles = await res.json();
        if (tiles && tiles.ndvi && tiles.ndvi_class) {
          setNdviTiles(tiles.ndvi, tiles.ndvi_class);
          currentDate = tiles.date;
          kpiDate.textContent = tiles.date;
          sliderDate.textContent = tiles.date;
        } else if (tiles && tiles.ndvi) {
          setNdviTiles(tiles.ndvi, tiles.ndvi);
          currentDate = tiles.date;
          kpiDate.textContent = tiles.date;
          sliderDate.textContent = tiles.date;
        } else if (!ndviFirstLoadDone) {
          setMapLoading(false);
        }
      }


      if (openFiltersBtn) {
        openFiltersBtn.addEventListener("click", () => {
          openFilters();
          initMiniMap();
        });
      }
      if (closeFiltersBtn) {
        closeFiltersBtn.addEventListener("click", closeFilters);
      }
      if (cancelFiltersBtn) {
        cancelFiltersBtn.addEventListener("click", closeFilters);
      }
      if (filtersOverlay) {
        filtersOverlay.addEventListener("click", (event) => {
          if (event.target === filtersOverlay) {
            closeFilters();
          }
        });
      }

      if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener("click", async () => {
          resetFilterSelection();
          restoreAllTalhoes();
          updateMiniMapLayer();
          if (importId) {
            try {
              await fetch(`/api/job/${jobId}/filter-selection`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ feature_ids: [] })
              });
            } catch (err) {
              // keep UI reset even if server fails
            }
          }
          await loadTiles(currentDate || baseDate);
        });
      }

      if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener("click", async () => {
          if (!filterConfig.farmField || !filterConfig.fieldField) {
            filtersError.textContent = "Selecione Campo Fazenda e Campo Talh√£o.";
            filtersError.style.display = "block";
            return;
          }
          if (!filterSelection.farmValue) {
            filtersError.textContent = "Selecione uma fazenda.";
            filtersError.style.display = "block";
            return;
          }
          if (!filterSelection.selectedFeatureIds.length) {
            filtersError.textContent = "Selecione ao menos um talh√£o.";
            filtersError.style.display = "block";
            return;
          }
          filtersError.textContent = "";
          filtersError.style.display = "none";

          if (talhoesGeojsonData) {
            const selectedIds = new Set(filterSelection.selectedFeatureIds.map((id) => Number(id)));
            const filtered = (talhoesGeojsonData.features || []).filter((feat) =>
              selectedIds.has(Number(feat?.properties?.id))
            );
            const exploded = explodeGeojson({ type: "FeatureCollection", features: filtered });
            exploded.features.forEach((feature, index) => {
              feature.properties = feature.properties || {};
              feature.properties.__index = feature.properties.__index ?? feature.properties.id ?? index;
            });
            setTalhoesLayer(exploded);
            if (talhoesLayer) {
              const bounds = talhoesLayer.getBounds();
              if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [24, 24] });
              }
            }
          }
          try {
            await fetch(`/api/job/${jobId}/filter-selection`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ feature_ids: filterSelection.selectedFeatureIds })
            });
          } catch (err) {
            // keep UI state even if server fails
          }
          await loadTiles(currentDate || baseDate);
          closeFilters();
        });
      }

      if (farmFieldSelect) {
        farmFieldSelect.addEventListener("change", (event) => {
          filterConfig.farmField = event.target.value;
          renderExamples(farmFieldExamples, filterConfig.farmField);
          validateFilterConfig();
        });
      }

      if (fieldFieldSelect) {
        fieldFieldSelect.addEventListener("change", (event) => {
          filterConfig.fieldField = event.target.value;
          renderExamples(fieldFieldExamples, filterConfig.fieldField);
          validateFilterConfig();
        });
      }

      if (selectAllFields) {
        selectAllFields.addEventListener("change", () => {
          filterSelection.selectAll = selectAllFields.checked;
          if (filterSelection.farmValue) {
            if (filterSelection.selectAll) {
              filterSelection.selectedFeatureIds = cachedFieldsAll.map((item) => Number(item.feature_id));
            } else {
              filterSelection.selectedFeatureIds = [];
            }
            renderFields(cachedFields);
          }
          updateMiniMapLayer();
        });
      }

      if (farmSearchInput) {
        farmSearchInput.addEventListener(
          "input",
          debounce((event) => {
            loadFarms(event.target.value || "");
          }, 300, "farm")
        );
      }

      if (fieldSearchInput) {
        fieldSearchInput.addEventListener(
          "input",
          debounce((event) => {
            if (!filterSelection.farmValue) return;
            loadFieldsByFarm(filterSelection.farmValue, event.target.value || "", false);
          }, 300, "field")
        );
      }

      cropSelect.addEventListener("change", async () => {
        const crop = cropSelect.value;
        await fetch(`/api/job/${jobId}/set_crop`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `crop=${encodeURIComponent(crop)}`
        });
        kpiCrop.textContent = crop;
        renderCropDescription(crop);
      });


      (async () => {
        const metaRes = await fetch(`/api/job/${jobId}/meta`);
        const meta = await metaRes.json();
        importId = meta.import_id || null;
        if (meta.crop) {
          cropSelect.value = meta.crop;
          kpiCrop.textContent = meta.crop;
          renderCropDescription(meta.crop);
        } else {
          renderCropDescription(cropSelect.value);
        }
        if (meta.bbox && meta.bbox.length === 4) {
          const bounds = L.latLngBounds(
            [meta.bbox[0], meta.bbox[1]],
            [meta.bbox[2], meta.bbox[3]]
          );
          map.fitBounds(bounds);
          map.setMaxBounds(bounds);
          map.options.maxBoundsViscosity = 1.0;
        } else {
          map.setView([-14.235, -51.925], 4);
        }
        if (importId) {
          const fieldsRes = await fetch(`/api/import/${importId}/fields`);
          const fieldsPayload = await fieldsRes.json();
          const fieldItems = Array.isArray(fieldsPayload.fields) ? fieldsPayload.fields : [];
          examplesByField = {};
          fieldItems.forEach((item) => {
            if (!item || !item.name) return;
            examplesByField[item.name] = Array.isArray(item.examples) ? item.examples : [];
            if (farmFieldSelect) {
              const opt = document.createElement("option");
              opt.value = item.name;
              opt.textContent = item.name;
              farmFieldSelect.appendChild(opt);
            }
            if (fieldFieldSelect) {
              const opt = document.createElement("option");
              opt.value = item.name;
              opt.textContent = item.name;
              fieldFieldSelect.appendChild(opt);
            }
          });
          await loadFarms("");
        }
        validateFilterConfig();
        await loadTiles(currentDate || meta.date || baseDate);
        await loadTalhoes();
      })();
    </script>
  </body>
</html>
