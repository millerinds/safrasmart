<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SafraSmart - NDVI</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <!-- Static/legacy dashboard layout -->
    <div class="dashboard">
      <!-- Top bar -->
      <div class="topbar">
        <div class="logo">
          <span>üåø</span>
          SafraSmart
        </div>
        <div class="status-indicator">
          <div class="status-item">
            <div class="status-dot"></div>
            <span>API Online</span>
          </div>
          <div class="status-item">
            <span>üìÖ {{ updated_date }}</span>
          </div>
          <button class="refresh-btn" type="button" onclick="window.location.reload()">
            <span>üîÑ</span>
            Atualizar
          </button>
        </div>
      </div>

      <div style="padding: 1.5rem 2rem 0;">
        <!-- KPI row -->
        <div class="kpi-section">
          <div class="kpi-card">
            <div class="kpi-header">
              <div class="kpi-icon green">üå±</div>
              <div class="kpi-label">NDVI M√©dio</div>
            </div>
            <div class="kpi-value">0.72</div>
            <div class="kpi-status">‚úì Saud√°vel</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-header">
              <div class="kpi-icon blue">üìç</div>
              <div class="kpi-label">Talh√µes</div>
            </div>
            <div class="kpi-value">{{ talhoes_count or '--' }}</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-header">
              <div class="kpi-icon purple">‚òÅÔ∏è</div>
              <div class="kpi-label">Nuvem M√©dia</div>
            </div>
            <div class="kpi-value">{{ cloud_pixel_percentage }}%</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-header">
              <div class="kpi-icon orange">üõ∞Ô∏è</div>
              <div class="kpi-label">√öltima Imagem</div>
            </div>
            <div class="kpi-value">{{ updated_date }}</div>
          </div>
        </div>
      </div>

      <div class="main-content">
        <div>
          <!-- Upload + controls -->
          <div class="form-card">
            <form method="post" action="/submit" enctype="multipart/form-data" class="form-grid">
              <div>
                <label for="cloud_pixel_percentage">Cobertura de nuvens</label>
                <input type="range" id="cloud_pixel_percentage" name="cloud_pixel_percentage" min="30" max="100" step="5" value="{{ cloud_pixel_percentage or 40 }}" />
                <div class="slider-meta">
                  <span id="cloud_value">{{ cloud_pixel_percentage or 40 }}%</span>
                  <span class="slider-tip">Recomendado: 30-40%</span>
                </div>
              </div>
              <div>
                <label for="aoi_files">Shapefile (.zip)</label>
                <input type="file" id="aoi_files" name="aoi_files" accept=".zip" />
              </div>
              <div>
                <label for="accessibility">Paleta</label>
                <select id="accessibility" name="accessibility">
                  {% for option in ['Normal','Deuteranopia','Protanopia','Tritanopia','Achromatopsia'] %}
                    <option value="{{ option }}" {% if accessibility == option %}selected{% endif %}>{{ option }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label for="initial_date">Data inicial</label>
                <input type="date" id="initial_date" name="initial_date" value="{{ initial_date }}" />
              </div>
              <div>
                <label for="updated_date">Data atualizada</label>
                <input type="date" id="updated_date" name="updated_date" value="{{ updated_date }}" />
              </div>
              <div>
                <label>&nbsp;</label>
                <button type="submit" class="primary">Gerar mapa</button>
              </div>
            </form>

            {% if form_errors %}
              <div class="errors">
                {% for err in form_errors %}
                  <div class="error">{{ err }}</div>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <!-- Map + legend -->
          <div class="map-container">
            <div class="map-controls">
              <button class="map-control-btn active">üìä NDVI</button>
              <button class="map-control-btn">üñºÔ∏è RGB</button>
              <button class="map-control-btn">üìê Talh√µes</button>
            </div>

            {% if map_html %}
              <div class="map-wrap">{{ map_html | safe }}</div>
            {% else %}
              <div class="map-wrap" style="display:flex;align-items:center;justify-content:center;color:var(--muted);">Envie um shapefile para gerar o mapa.</div>
            {% endif %}

            <!-- NDVI legend -->
            <div class="legend">
              <div class="legend-title">√çndice NDVI</div>
              <div class="legend-item">
                <div class="legend-color" style="background: {{ reclassified_ndvi_palette[6] }};"></div>
                <span>0.7 - 1.0 Saud√°vel</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: {{ reclassified_ndvi_palette[4] }};"></div>
                <span>0.5 - 0.7 M√©dio</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: {{ reclassified_ndvi_palette[0] }};"></div>
                <span>0.0 - 0.5 Alerta</span>
              </div>
            </div>
          </div>
        </div>

        <div class="side-panel">
          <!-- Selected polygon info -->
          <div class="panel-card">
            <div class="panel-title">üìç Talh√£o selecionado</div>
            <div class="info-row">
              <span class="info-label">√Årea</span>
              <span class="info-value">-- ha</span>
            </div>
            <div class="info-row">
              <span class="info-label">NDVI Atual</span>
              <span class="info-value">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">Status</span>
              <span class="info-value">--</span>
            </div>
          </div>

          <!-- Placeholder chart -->
          <div class="panel-card">
            <div class="panel-title">üìà Hist√≥rico NDVI (60 dias)</div>
            <div class="chart-container" style="display:flex;align-items:center;justify-content:center;color:var(--muted);">
              Gr√°fico em breve
            </div>
          </div>

          <!-- Alerts -->
          <div class="panel-card">
            <div class="panel-title">üö® Alertas Recentes</div>
            <div class="alert-item">
              <div class="alert-time">H√° 15 min</div>
              <div class="alert-message">Talh√£o com NDVI abaixo do esperado.</div>
            </div>
            <div class="alert-item">
              <div class="alert-time">H√° 2 horas</div>
              <div class="alert-message">Poss√≠vel estresse h√≠drico detectado.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      (function () {
        const slider = document.getElementById('cloud_pixel_percentage');
        const label = document.getElementById('cloud_value');
        if (!slider || !label) return;
        const update = () => { label.textContent = `${slider.value}%`; };
        slider.addEventListener('input', update);
        update();
      }());
    </script>
  </body>
</html>
